# Manage Syncthing Container and Services Using Podman, Systemd, and Quadlet

1. **Configure Environment:** Create a `.env` file in the `./config` directory by copying the contents of the `env.example` file. This file will hold the necessary environment variables for your Syncthing setup.

    ```bash
    cp ./config/env.example ./config/.env
    ```

2. **Navigate to Scripts Directory:** Change your current directory to the `./scripts` directory, where the Makefile is located.

    ```bash
    cd ./scripts
    ```

## Make Commands

You can use the following `make` commands:

- **Deploy Syncthing as a container and start using systemd service:**

    ```bash
    make install
    ```

- **Remove the Syncthing container and its services without deleting data volumes:**

    ```bash
    make uninstall
    ```

- **Remove the Syncthing data volumes:**

    ```bash
    make remove-volumes
    ```

- **Debug the systemd service file generated by Quadlet:**

    ```bash
    make debug
    ```

> **Note:**
>
> - The Quadlet binary location may vary depending on your distribution.
> - The default locations (configurable in the `Makefile`) are:
>   - For Debian-based systems: `/usr/libexec/podman/quadlet`
>   - For Fedora-based systems: `/usr/libexec/podman/quadlet`
>   - For Arch-based systems: `/usr/lib/podman/quadlet`

## Manage Using Systemd

- **Disable the service to prevent it from starting automatically:**

    ```bash
    systemctl --user disable syncthing-server.service
    ```

- **Enable the service to allow it to start automatically:**

    ```bash
    systemctl --user enable syncthing-server.service
    ```

## Network Configuration

Access Syncthing on the local machine at:

- **Syncthing Application:** [http://localhost:8384](http://localhost:8384)

## Firewall Configuration

Open the following ports:

- Port 22000/TCP: TCP-based sync protocol traffic
- Port 22000/UDP: QUIC-based sync protocol traffic
- Port 21027/UDP: for discovery broadcasts on IPv4 and multicasts on IPv6

If using Firewalld, enable the ports by running:

```bash
sudo firewall-cmd --zone=public --add-service=syncthing --permanent
sudo firewall-cmd --reload
```

## Post-Installation Configuration

After installing Syncthing, follow these steps to configure folder storage:

1. **Navigate to the Settings Page**  
   - Open Syncthing's web interface at [http://localhost:8384](http://localhost:8384).
   - Click on **Actions** > **Settings** > **General**.

2. **Modify Default Folder Configuration**
   - Go to the **Default Configuration** section.
   - Click **Edit Folder Defaults**.

3. **Set the Folder Path**
   - To use the **Syncthing data volume**, set the **Folder Path** to:

     ```plaintext
     /data
     ```

   - To store synced data in a directory on your **host system**, set the **Folder Path** to:

     ```plaintext
     /external-data
     ```

4. **Save Changes**
   - Click **Save** to apply the settings.

## Note

1. The container runs as `root (User 0)` to address file permission issues when accessing external directories within a rootless container. In this context, `root (User 0)` inside the container maps to a non-root host user (e.g., UID 1000).

2. The network mode is configured as `host` to enable Syncthing's local network discovery. This is necessary because Podman's default bridge network does not forward broadcast or multicast packets, which Syncthing relies on for LAN discovery (UDP 21027).
